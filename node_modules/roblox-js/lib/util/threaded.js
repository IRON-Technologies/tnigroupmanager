// Dependencies
var Promise = require('bluebird');

// Includes
var settings = require('../../settings.json');

// Define
module.exports = function (getPage, start, end) {
  var completed = 0;
  var expected = end - start;
  function next (resolve, i, ivl, tries) {
    // console.log('Next ' + i + ' each ' + ivl);
    if (i >= end) {
      return;
    }
    if (i < start) {
      next(resolve, i + ivl, ivl, 0);
      return;
    }
    if (tries > 2) {
      expected--;
      console.error('Ran out of tries for ' + i);
      if (completed >= expected) {
        resolve();
      } else {
        next(resolve, i + ivl, ivl, 0);
      }
      return;
    }
    var res = getPage(i);
    if (res && res.then) {
      res.then(function () {
        completed++;
        if (completed >= expected) {
          resolve();
          return;
        }
        next(resolve, i + ivl, ivl, 0);
      })
      .catch(function (err) {
        console.error('Thread error: ' + err.stack);
        next(resolve, i, ivl, tries + 1);
      });
    } else {
      expected--;
      if (completed >= expected) {
        resolve();
        return;
      }
      next(resolve, i + ivl, ivl, 0);
    }
  }

  var promise = new Promise(function (resolve) {
    if (expected <= 0) {
      resolve();
      return;
    }
    var ivl = Math.min(settings.maxThreads, expected);
    for (var i = 0; i < ivl; i++) {
      next(resolve, i, ivl, 0);
    }
  });
  promise.getStatus = function () {
    return Math.round((completed / expected) * 10000) / 100 || 0;
  };
  promise.getCompleted = function () {
    return completed;
  };
  promise.getExpected = function () {
    return expected;
  };
  return promise;
};
